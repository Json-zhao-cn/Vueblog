import{_ as s,c as a,a as e,o as p}from"./app-BWHYZH_D.js";const t={};function o(c,n){return p(),a("div",null,[...n[0]||(n[0]=[e(`<h3 id="using-merge-into-sql-script-to-update-insert-and-delete-data-in-the-two-tables" tabindex="-1"><a class="header-anchor" href="#using-merge-into-sql-script-to-update-insert-and-delete-data-in-the-two-tables"><span>Using merge into SQL Script to update,insert and delete data in the two tables</span></a></h3><p>In the SQL Server, if we want to UID(Update,insert and delete) rows between TableA and TableB.</p><h4 id="_1-no-condition" tabindex="-1"><a class="header-anchor" href="#_1-no-condition"><span>1. No condition</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">MERGE</span> <span class="token keyword">INTO</span> TestA <span class="token keyword">AS</span> Target</span>
<span class="line"><span class="token keyword">USING</span> TestB <span class="token keyword">AS</span> Source</span>
<span class="line"><span class="token keyword">ON</span> Target<span class="token punctuation">.</span>Id <span class="token operator">=</span> Source<span class="token punctuation">.</span>Id</span>
<span class="line"><span class="token comment">-- Update existing records when data differs</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span></span>
<span class="line">        Target<span class="token punctuation">.</span>Name <span class="token operator">=</span> Source<span class="token punctuation">.</span>Name<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>CreateOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>CreateOn<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>UpdateOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>CloseOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>CloseOn<span class="token punctuation">,</span></span>
<span class="line"><span class="token comment">-- Insert new records that don&#39;t exist in target</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> TARGET <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>Id<span class="token punctuation">,</span> Name<span class="token punctuation">,</span> CreateOn<span class="token punctuation">,</span> UpdateOn<span class="token punctuation">,</span>CloseOn<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>Source<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>CreateOn<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span>Source<span class="token punctuation">.</span>CloseOn<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">-- Delete records that no longer exist in source (with age restriction)</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> SOURCE <span class="token keyword">then</span></span>
<span class="line">    <span class="token keyword">DELETE</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-has-query-condition" tabindex="-1"><a class="header-anchor" href="#_2-has-query-condition"><span>2. Has Query Condition</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">MERGE</span> <span class="token keyword">INTO</span> TestA <span class="token keyword">AS</span> Target</span>
<span class="line"><span class="token keyword">USING</span> TestB <span class="token keyword">AS</span> Source</span>
<span class="line"><span class="token keyword">ON</span> Target<span class="token punctuation">.</span>Id <span class="token operator">=</span> Source<span class="token punctuation">.</span>Id</span>
<span class="line"></span>
<span class="line"><span class="token comment">-- Update existing records when data differs</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token operator">AND</span> <span class="token punctuation">(</span></span>
<span class="line">    isnull<span class="token punctuation">(</span>Target<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span> Target<span class="token punctuation">.</span>CreateOn<span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span>isnull<span class="token punctuation">(</span>Source<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>CreateOn<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span></span>
<span class="line">        Target<span class="token punctuation">.</span>Name <span class="token operator">=</span> Source<span class="token punctuation">.</span>Name<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>CreateOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>CreateOn<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>UpdateOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>CloseOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>CloseOn</span>
<span class="line"><span class="token comment">-- Insert new records that don&#39;t exist in target</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> TARGET <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>Id<span class="token punctuation">,</span> Name<span class="token punctuation">,</span> CreateOn<span class="token punctuation">,</span> UpdateOn<span class="token punctuation">,</span>CloseOn<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>Source<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>CreateOn<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span>Source<span class="token punctuation">.</span>CloseOn<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">-- Delete records that no longer exist in source (with age restriction)</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> SOURCE <span class="token operator">AND</span> <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">DELETE</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-has-query-condition-multiple-columns" tabindex="-1"><a class="header-anchor" href="#_3-has-query-condition-multiple-columns"><span>3. Has Query Condition(Multiple columns)</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">MERGE</span> <span class="token keyword">INTO</span> TestA <span class="token keyword">AS</span> Target</span>
<span class="line"><span class="token keyword">USING</span> TestB <span class="token keyword">AS</span> Source</span>
<span class="line"><span class="token keyword">ON</span> Target<span class="token punctuation">.</span>Id <span class="token operator">=</span> Source<span class="token punctuation">.</span>Id</span>
<span class="line"><span class="token comment">-- Update existing records when data differs</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token operator">AND</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">COALESCE</span><span class="token punctuation">(</span>Target<span class="token punctuation">.</span>CloseOn<span class="token punctuation">,</span>Target<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span> Target<span class="token punctuation">.</span>CreateOn<span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span><span class="token keyword">COALESCE</span><span class="token punctuation">(</span>Source<span class="token punctuation">.</span>CloseOn<span class="token punctuation">,</span>Source<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>CreateOn<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span></span>
<span class="line">        Target<span class="token punctuation">.</span>Name <span class="token operator">=</span> Source<span class="token punctuation">.</span>Name<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>CreateOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>CreateOn<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>UpdateOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>CloseOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>CloseOn</span>
<span class="line"><span class="token comment">-- Insert new records that don&#39;t exist in target</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> TARGET <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>Id<span class="token punctuation">,</span> Name<span class="token punctuation">,</span> CreateOn<span class="token punctuation">,</span> UpdateOn<span class="token punctuation">,</span>CloseOn<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>Source<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>CreateOn<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>CloseOn<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">-- Delete records that no longer exist in source (with age restriction)</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> SOURCE <span class="token operator">AND</span> <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">DELETE</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-has-delete-condition" tabindex="-1"><a class="header-anchor" href="#_4-has-delete-condition"><span>4. Has delete condition</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre><code><span class="line"><span class="token keyword">MERGE</span> <span class="token keyword">INTO</span> TestA <span class="token keyword">AS</span> Target</span>
<span class="line"><span class="token keyword">USING</span> TestB <span class="token keyword">AS</span> Source</span>
<span class="line"><span class="token keyword">ON</span> Target<span class="token punctuation">.</span>Id <span class="token operator">=</span> Source<span class="token punctuation">.</span>Id</span>
<span class="line"><span class="token comment">-- Update existing records when data differs</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token keyword">MATCHED</span> <span class="token operator">AND</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">COALESCE</span><span class="token punctuation">(</span>Target<span class="token punctuation">.</span>CloseOn<span class="token punctuation">,</span>Target<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span> Target<span class="token punctuation">.</span>CreateOn<span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span><span class="token keyword">COALESCE</span><span class="token punctuation">(</span>Source<span class="token punctuation">.</span>CloseOn<span class="token punctuation">,</span>Source<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>CreateOn<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">UPDATE</span> <span class="token keyword">SET</span></span>
<span class="line">        Target<span class="token punctuation">.</span>Name <span class="token operator">=</span> Source<span class="token punctuation">.</span>Name<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>CreateOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>CreateOn<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>UpdateOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span></span>
<span class="line">        Target<span class="token punctuation">.</span>CloseOn <span class="token operator">=</span> Source<span class="token punctuation">.</span>CloseOn</span>
<span class="line"><span class="token comment">-- Insert new records that don&#39;t exist in target</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> TARGET <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">INSERT</span> <span class="token punctuation">(</span>Id<span class="token punctuation">,</span> Name<span class="token punctuation">,</span> CreateOn<span class="token punctuation">,</span> UpdateOn<span class="token punctuation">,</span>CloseOn<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>Source<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>CreateOn<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>UpdateOn<span class="token punctuation">,</span> Source<span class="token punctuation">.</span>CloseOn<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">-- Delete records that no longer exist in source (with age restriction)</span></span>
<span class="line"><span class="token keyword">WHEN</span> <span class="token operator">NOT</span> <span class="token keyword">MATCHED</span> <span class="token keyword">BY</span> SOURCE <span class="token operator">AND</span> </span>
<span class="line">    Target<span class="token punctuation">.</span>UpdateOn <span class="token operator">&gt;</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">DAY</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span></span>
<span class="line">    <span class="token keyword">DELETE</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,10)])])}const i=s(t,[["render",o]]),u=JSON.parse('{"path":"/blogs/Skills/SQLServer/Funcation/MergeFuncation.html","title":"Using merge into SQL Script to update,insert and delete data in the two tables","lang":"en-US","frontmatter":{"title":"Using merge into SQL Script to update,insert and delete data in the two tables","date":"2025/11/20","tags":["SQLServer"],"categories":["Skills"]},"headers":[{"level":3,"title":"Using merge into SQL Script to update,insert and delete data in the two tables","slug":"using-merge-into-sql-script-to-update-insert-and-delete-data-in-the-two-tables","link":"#using-merge-into-sql-script-to-update-insert-and-delete-data-in-the-two-tables","children":[]},{"level":3,"title":"4. Has delete condition","slug":"_4-has-delete-condition","link":"#_4-has-delete-condition","children":[]}],"git":{"createdTime":1763625686000,"updatedTime":1763625686000,"contributors":[{"name":"jsonzhao","email":"json.zhao.cn@outlook.com","commits":1}]},"filePathRelative":"blogs/Skills/SQLServer/Funcation/MergeFuncation.md"}');export{i as comp,u as data};
